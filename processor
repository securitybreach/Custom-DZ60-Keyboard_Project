atmega32u4 = MCU
32u4  has 32k of flash memory
4k is the bootloader, 28k is for user programs
the bootloader is the DFU program that allows you to flash it over USB
when an MCU is blank, it boots directly into the bootloader
when it has a program it just runs the program directly and skips the bootloader
the first 4k is protected from normal user space and should not be written to in the normal case, but like all hardware, bugs happen and it can corrupt 
QMK is just a program that resides in that user partition
the reason is there's only 2k of eeprom
so we don't have enough space to be expressive enough

ewer MCUs like the ones based on arm are much bigger or use eeprom emulation so in the future expect to see keyboards that let you update the keymap without flashing the firmware

On the qmk configurator, hit compile after making changes and then click download Firmware (in hex)

yanfaliToday at 10:17 AM
cool. Do you see the "COMPILE" button ?
comhackToday at 10:17 AM
Yeah
yanfaliToday at 10:17 AM
is your JSON loaded?
comhackToday at 10:17 AM
Yup
yanfaliToday at 10:17 AM
hit compile
comhackToday at 10:17 AM
Ha, I thought you just exported it after making changes lol
Its running
yanfaliToday at 10:18 AM
lol
comhackToday at 10:18 AM
* File size is fine - 23692/28672 (4980 free)
yanfaliToday at 10:18 AM
export is the equiv of saving
cool
comhackToday at 10:18 AM
Ah, so I was right
yanfaliToday at 10:18 AM
now a button called "Download Firmware" should be enabled
comhackToday at 10:18 AM
Just didnt know that I had to compile first to export
Ok
dz60_dz60_layout_2_shifts_mine.hex
yanfaliToday at 10:19 AM
yes!
ok that is an ascii version of the firmware
if you open it in an editor you will see hex values
DFU accepts that input and turns it into binary
comhackToday at 10:19 AM
Right
yanfaliToday at 10:19 AM
ok let me test something locally
comhackToday at 10:19 AM
ok
yanfaliToday at 10:20 AM
ok so when I reset my keyboard I see this
Sep 01 08:20:21 ptah kernel: usb 1-1.1: new full-speed USB device number 4 using ehci-pci
Sep 01 08:20:22 ptah kernel: usb 1-1.1: New USB device found, idVendor=03eb, idProduct=2ff4, bcdDevice= 0.00
Sep 01 08:20:22 ptah kernel: usb 1-1.1: New USB device strings: Mfr=1, Product=2, SerialNumber=3
Sep 01 08:20:22 ptah kernel: usb 1-1.1: Product: ATm32U4DFU
Sep 01 08:20:22 ptah kernel: usb 1-1.1: Manufacturer: ATMEL
Sep 01 08:20:22 ptah kernel: usb 1-1.1: SerialNumber: 1.0.0
comhackToday at 10:21 AM
via dmesg?
yanfaliToday at 10:21 AM
I used journalctl -f
comhackToday at 10:21 AM
ok
yanfaliToday at 10:21 AM
but yes same thing
comhackToday at 10:21 AM
right
do I need to be root to do these commands?
ok about to hit reset
yanfaliToday at 10:22 AM
not to see initial dfu but to run commands after yes. It writes to /sys
comhackToday at 10:22 AM
Here goes nothing
yanfaliToday at 10:22 AM
ï¿¼ good luck
comhackToday at 10:22 AM
ok
Sep 01 10:21:09 Cerberus sudo[15690]: pam_unix(sudo:session): session opened for user root by (uid=0)
Sep 01 10:21:09 Cerberus su[15725]: (to root) comhack on pts/4
Sep 01 10:21:09 Cerberus su[15725]: pam_unix(su:session): session opened for user root by (uid=0)
Sep 01 10:21:45 Cerberus kernel: usb 2-4: USB disconnect, device number 4
Sep 01 10:21:45 Cerberus kernel: usb 2-4: new full-speed USB device number 10 using xhci_hcd
Sep 01 10:21:45 Cerberus kernel: usb 2-4: New USB device found, idVendor=03eb, idProduct=2ff4, bcdDevice= 0.00
Sep 01 10:21:45 Cerberus kernel: usb 2-4: New USB device strings: Mfr=1, Product=2, SerialNumber=3
Sep 01 10:21:45 Cerberus kernel: usb 2-4: Product: ATm32U4DFU
Sep 01 10:21:45 Cerberus kernel: usb 2-4: Manufacturer: ATMEL
Sep 01 10:21:45 Cerberus kernel: usb 2-4: SerialNumber: 1.0.0
yanfaliToday at 10:22 AM
NICE
so now the keyboard is ready for flashing
so let's test this basic command
comhackToday at 10:23 AM
ok
yanfaliToday at 10:24 AM
dfu-programmer atmega32u4 reset
that should put the keyboard back into keyboard mode
it's basically a test to see dfu-programmer can find the device
comhackToday at 10:24 AM
Ok
terminal returned no outpu
#output
yanfaliToday at 10:25 AM
try typing on the keyboard again
it should be back
comhackToday at 10:25 AM
Yeah
yanfaliToday at 10:25 AM
cool
that means we have everything you need
comhackToday at 10:25 AM
Sweet
yanfaliToday at 10:25 AM
ok flashing a new firmware is in 2 parts
1. erase
2. program
comhackToday at 10:25 AM
ok
yanfaliToday at 10:25 AM
dfu requires we erase the flash first because it checks on writing to see if something is there
comhackToday at 10:26 AM
gotcha
yanfaliToday at 10:26 AM
ok so put keyboard back into dfu
comhackToday at 10:26 AM
Ill save this conversation when we are done
yanfaliToday at 10:26 AM
definitely
dfu-programmer atmega32u4 erase
comhackToday at 10:27 AM
so dfu-programmer atmega32u4 reset
yanfaliToday at 10:27 AM
will send the erase command to the keyboard
comhackToday at 10:27 AM
first or the erase
yanfaliToday at 10:27 AM
reset is actually the last step
comhackToday at 10:27 AM
I have to put it back into reset mode, right
So even with it working, we erase
yanfaliToday at 10:27 AM
yep. put keyboard back into bootloader
comhackToday at 10:27 AM
ok
back in bootloader mode
yanfaliToday at 10:27 AM
sorry, the reset part was testing DFU
to make sure we could see the keyboard
comhackToday at 10:27 AM
with caps-reset
yanfaliToday at 10:28 AM
yep. the dfu-programmer reset is different from the QMK reset
the terminology is confusing
comhackToday at 10:28 AM
So what do you want me to run first
right now I am in bootloader mode
yanfaliToday at 10:28 AM
but think of the dfu reset as bring me back to use program
1. erase
comhackToday at 10:28 AM
caps-reset
So put it back in non-reset mode
??
yanfaliToday at 10:28 AM
ok. my bad
starting from the beginning
1. put keyboard into bootloader
comhackToday at 10:29 AM
reset mode done
yanfaliToday at 10:29 AM
2. run erase
comhackToday at 10:29 AM
so now run dfu-programmer atmega32u4 erase
yanfaliToday at 10:29 AM
yes sir
comhackToday at 10:29 AM
Checking memory from 0x0 to 0x6FFF...  Not blank at 0x1.
Erasing flash...  Success
Checking memory from 0x0 to 0x6FFF...  Empty.
yanfaliToday at 10:30 AM
now the keyboard is blank
it only has bootloader
comhackToday at 10:30 AM
ok
right
yanfaliToday at 10:31 AM
dfu-programmer atmega32u4 flash <filename.hex>
so obviously substitute your hex file name for the last part
comhackToday at 10:32 AM
done
Checking memory from 0x0 to 0x5CFF...  Empty.
0%                            100%  Programming 0x5D00 bytes...
[>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>]  Success
0%                            100%  Reading 0x7000 bytes...
[>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>]  Success
Validating...  Success
0x5D00 bytes written into 0x7000 bytes memory (83.04%).
yanfaliToday at 10:32 AM
dfu-programmer atmega32u4 reset
and you are done
comhackToday at 10:32 AM
That was simple
yanfaliToday at 10:32 AM
then go test your new keymap
comhackToday at 10:33 AM
I thought it was more involved than that
Works
yanfaliToday at 10:33 AM
yeah. it really is
comhackToday at 10:33 AM
Damn
Thanks
yanfaliToday at 10:33 AM
it just seems complicated at first
comhackToday at 10:33 AM
That wiki is so conviluted
yanfaliToday at 10:33 AM
the complicated part is how many ways there are to flash
and how many mcus there are
comhackToday at 10:33 AM
#convoluted
yanfaliToday at 10:33 AM
yeah, that's unfortunate. Not all keyboards run dfu
we have a lot of keyboards that use pro micros
comhackToday at 10:33 AM
Cool
Thanks
NEW MESSAGES
yanfaliToday at 10:34 AM
those have a different method
you're welcome







root@Cerberus /old-home/comhack/Downloads # journalctl -f
-- Logs begin at Mon 2018-08-13 05:52:01 CDT. --
Sep 01 10:21:09 Cerberus sudo[15690]: pam_unix(sudo:session): session opened for user root by (uid=0)
Sep 01 10:21:09 Cerberus su[15725]: (to root) comhack on pts/4
Sep 01 10:21:09 Cerberus su[15725]: pam_unix(su:session): session opened for user root by (uid=0)
Sep 01 10:21:45 Cerberus kernel: usb 2-4: USB disconnect, device number 4
Sep 01 10:21:45 Cerberus kernel: usb 2-4: new full-speed USB device number 10 using xhci_hcd
Sep 01 10:21:45 Cerberus kernel: usb 2-4: New USB device found, idVendor=03eb, idProduct=2ff4, bcdDevice= 0.00
Sep 01 10:21:45 Cerberus kernel: usb 2-4: New USB device strings: Mfr=1, Product=2, SerialNumber=3
Sep 01 10:21:45 Cerberus kernel: usb 2-4: Product: ATm32U4DFU
Sep 01 10:21:45 Cerberus kernel: usb 2-4: Manufacturer: ATMEL
Sep 01 10:21:45 Cerberus kernel: usb 2-4: SerialNumber: 1.0.0
q
^C
130 root@Cerberus /old-home/comhack/Downloads # dfu-programmer atmega32u4 reset                                                                           :(
root@Cerberus /old-home/comhack/Downloads # dfu-programmer atmega32u4 erase 
Checking memory from 0x0 to 0x6FFF...  Not blank at 0x1.
Erasing flash...  Success
Checking memory from 0x0 to 0x6FFF...  Empty.
root@Cerberus /old-home/comhack/Downloads # dfu-programmer atmega32u4 flash dz60_dz60_layout_2_shifts_mine.hex 
Checking memory from 0x0 to 0x5CFF...  Empty.
0%                            100%  Programming 0x5D00 bytes...
[>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>]  Success
0%                            100%  Reading 0x7000 bytes...
[>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>]  Success
Validating...  Success
0x5D00 bytes written into 0x7000 bytes memory (83.04%).
root@Cerberus /old-home/comhack/Downloads # dfu-programmer atmega32u4 reset                                   
root@Cerberus /old-home/comhack/Downloads # 

